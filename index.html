<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator E-flyer GKI Griya Merpati Mas</title>
    <link rel="icon" href="data:,">
    
    <style>
        :root {
            --primary-color: #004aad;
            --secondary-color: #f5f7fa;
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --pexels-color: #05A081; 
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--secondary-color); color: var(--text-color); line-height: 1.6; padding: 20px; }
        
        header { text-align: center; margin-bottom: 30px; }
        header h1 { color: var(--primary-color); margin-bottom: 5px; font-size: 1.8rem; }
        header p { color: #666; font-size: 0.9rem; }

        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

        /* Panel Kontrol */
        .control-panel { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; }

        /* Buttons */
        .btn { display: inline-block; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; text-decoration: none; text-align: center; width: 100%; }
        
        .btn-pexels { background: var(--pexels-color); color: white; margin-bottom: 10px; }
        .btn-pexels:hover { background: '#048067'; }

        .btn-primary { background: var(--primary-color); color: white; margin-top: 5px;}
        .btn-primary:hover { background: #003380; }
        
        .file-upload-wrapper { margin-bottom: 10px; border: 1px dashed #ccc; padding: 10px; border-radius: 8px; background: #fafafa; }
        .file-upload-label { display: inline-block; padding: 6px 12px; background: #555; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        input[type="file"] { display: none; }
        input[type="color"] { height: 40px; padding: 2px; cursor: pointer; }
        .file-name-display { font-size: 0.8rem; color: #555; margin-top: 5px; }

        /* Preset Grid */
        .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .preset-option { border: 2px solid transparent; border-radius: 6px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .preset-option:hover { transform: scale(1.02); }
        .preset-option.active { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 74, 173, 0.3); }
        .preset-option img { width: 100%; height: 70px; object-fit: cover; display: block; }

        /* Preview */
        .preview-panel { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; position: sticky; top: 20px; }
        .canvas-container { width: 100%; max-width: 500px; border: 1px solid #eee; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; aspect-ratio: 3/4; background: #f9f9f9; }
        canvas { width: 100%; height: 100%; display: block; }

        .action-buttons { display: flex; gap: 15px; width: 100%; }
        .btn-action { flex: 1; padding: 12px; font-size: 1rem; border-radius: 6px; border:none; cursor: pointer; font-weight: 600; }
        .btn-dl { background: var(--success-color); color: white; }
        .btn-rst { background: #6c757d; color: white; }

        .hidden { display: none; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 24px; border-radius: 6px; opacity: 0; transition: opacity 0.3s; z-index: 1000; max-width: 300px; text-align: center; font-size: 0.9rem;}
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <header>
        <h1>Generator E-flyer Kebaktian</h1>
        <p>GKI Griya Merpati Mas - Versi Lengkap</p>
    </header>

    <div class="container">
        <!-- Kolom Input -->
        <section class="control-panel">
            <form id="flyerForm">
                
                <!-- 1. Desain -->
                <h3>1. Pengaturan Desain</h3>
                <hr style="margin: 10px 0 20px; border: 0; border-top: 1px solid #eee;">
                
                <!-- Logo Section -->
                <div class="form-group">
                    <label>Logo Gereja</label>
                    <small style="display:block; margin-bottom:5px; color:#666; font-size:0.75rem;">
                        Jika logo di atas tidak muncul, gunakan tombol ini:
                    </small>
                    <div class="file-upload-wrapper">
                        <label for="logoFile" class="file-upload-label">Pilih File Logo (Manual)</label>
                        <input type="file" id="logoFile" accept="image/*">
                        <div id="logoFileName" class="file-name-display">Menggunakan path otomatis</div>
                    </div>
                </div>

                <!-- Warna Teks Section -->
                <div class="form-group">
                    <label>Warna Teks Utama</label>
                    <label style="font-weight:normal; font-size:0.85rem; margin-bottom:5px;">
                        <input type="checkbox" id="autoColorCheck" checked onchange="toggleColorInput()"> 
                        Warna Otomatis (Sesuaikan dengan Frame)
                    </label>
                    <input type="color" id="customColorPicker" class="form-control hidden" value="#ffffff" title="Pilih warna custom">
                </div>

                <!-- Frame Section -->
                <div class="form-group">
                    <!-- Tombol Pexels -->
                    <button type="button" class="btn btn-pexels" onclick="window.open('https://www.pexels.com/search/church/', '_blank')">
                        üñºÔ∏è Cari Gambar di Pexels
                    </button>
                    <small style="display:block; margin-bottom:5px; color:#555;">
                        Cara: Klik Kanan pada gambar pilihan -> <br>
                        <strong>"Copy Image Address"</strong> (Bukan Copy Link).
                    </small>
                    
                    <label>Tempel Link Gambar (URL):</label>
                    <input type="text" id="frameUrlInput" class="form-control" placeholder="https://images.pexels.com/photos/...">
                    <button type="button" id="btnLoadUrl" class="btn btn-primary">Gunakan Link Ini</button>
                </div>

                <div class="form-group">
                    <!-- Upload Custom Frame -->
                    <div class="file-upload-wrapper">
                        <label for="customFrame" class="file-upload-label">Upload Bingkai Sendiri (File)</label>
                        <input type="file" id="customFrame" accept="image/*">
                        <div id="customFrameName" class="file-name-display">Jika Link gagal, gunakan upload file</div>
                    </div>
                </div>

                <!-- Presets -->
                <label>Pilihan Preset:</label>
                <div class="preset-grid" id="framePresets"></div>

                <br>
                <!-- 2. Detail Kebaktian -->
                <h3>2. Detail Acara</h3>
                <hr style="margin: 10px 0 20px; border: 0; border-top: 1px solid #eee;">

                <div class="form-group">
                    <label for="serviceType">Jenis Kebaktian</label>
                    <select id="serviceType" class="form-control">
                        <option value="umum">Kebaktian Umum</option>
                        <option value="remaja">Kebaktian Remaja - Pemuda</option>
                        <option value="dewasa">Persekutuan Dewasa</option>
                        <option value="rt">Kebaktian Rumah Tangga</option>
                        <option value="syukur">Kebaktian Syukur</option>
                    </select>
                </div>

                <!-- Fields Umum -->
                <div id="section-umum" class="dynamic-section">
                    <div class="form-group"><label>Tanggal</label><input type="date" id="dateUmum" class="form-control"></div>
                    <div class="form-group"><label>Waktu Kebaktian I</label><input type="text" id="waktu1" class="form-control" value="07.00 WIB"></div>
                    <div class="form-group"><label>Waktu Kebaktian II</label><input type="text" id="waktu2" class="form-control" value="09.00 WIB"></div>
                    <div class="form-group"><label>Tema</label><input type="text" id="temaUmum" class="form-control" value="Kasih Karunia yang Memulihkan"></div>
                    <div class="form-group"><label>Pelayan Firman</label><input type="text" id="pelayanUmum" class="form-control" value="Pdt. Rumenta Santyani Manurung"></div>
                    <div class="form-group"><label>Asal Gereja</label><input type="text" id="asalGerejaUmum" class="form-control" value="GKI Griya Merpati Mas"></div>
                </div>

                <!-- Fields Remaja / Dewasa -->
                <div id="section-remaja-dewasa" class="dynamic-section hidden">
                    <div class="form-group"><label>Tanggal</label><input type="date" id="dateRD" class="form-control"></div>
                    <div class="form-group"><label>Waktu</label><input type="text" id="waktuRD" class="form-control" value="11.00 WIB"></div>
                    <div class="form-group"><label>Tema</label><input type="text" id="temaRD" class="form-control" value="Berani Beda"></div>
                    <div class="form-group"><label>Pelayan Firman</label><input type="text" id="pelayanRD" class="form-control" value="Pdt. Rumenta Santyani Manurung"></div>
                    <div class="form-group"><label>Asal Gereja</label><input type="text" id="asalGerejaRD" class="form-control" value="GKI Griya Merpati Mas"></div>
                </div>

                <!-- Fields RT / Syukur -->
                <div id="section-rt-syukur" class="dynamic-section hidden">
                    <div class="form-group"><label>Tanggal</label><input type="date" id="dateRT" class="form-control"></div>
                    <div class="form-group"><label>Waktu</label><input type="text" id="waktuRT" class="form-control" value="18.00 WIB"></div>
                    <div class="form-group"><label>Wilayah / Area</label><input type="text" id="wilayahRT" class="form-control" value="Wilayah Blok A"></div>
                    <div class="form-group"><label>Nama Keluarga / Host</label><input type="text" id="namaKeluarga" class="form-control" value="Klg. Bpk. Budi"></div>
                    <div class="form-group"><label>Alamat</label><input type="text" id="alamatRT" class="form-control" value="Jl. Damai Sejahtera No. 12"></div>
                    <div class="form-group"><label>Pelayan Firman</label><input type="text" id="pelayanRT" class="form-control" value="Pdt. Timotius"></div>
                </div>

            </form>
        </section>

        <!-- Kolom Preview -->
        <section class="preview-panel">
            <h3>Pratinjau</h3>
            <div class="canvas-container">
                <canvas id="flyerCanvas"></canvas>
            </div>
            <div class="action-buttons">
                <button type="button" class="btn-action btn-rst" id="resetBtn">Reset</button>
                <button type="button" class="btn-action btn-dl" id="downloadBtn">Unduh Gambar</button>
            </div>
        </section>
    </div>

    <div id="toast" class="toast">Notifikasi</div>

    <script>
        /**
         * SETUP & CONSTANTS
         */
        const canvas = document.getElementById('flyerCanvas');
        const ctx = canvas.getContext('2d');
        const W = 1080, H = 1440;
        canvas.width = W;
        canvas.height = H;

        const PERMANENT_CHURCH_NAME = "GKI Griya Merpati Mas";
        const PERMANENT_LOGO_URL = "gki-gereja-kristen-indonesia-logo-png_seeklogo-536222.png";

        const state = {
            churchName: PERMANENT_CHURCH_NAME,
            logo: null, 
            logoLoaded: false,
            frame: null, 
            isCustomFrame: false,
            type: 'umum',
            data: {},
            autoColor: true,
            customColor: '#ffffff'
        };

        const frames = [
            { url: 'https://picsum.photos/seed/gki1/600/800', name: 'Style 1 (Gelap)' },
            { url: 'https://picsum.photos/seed/gki-white/600/800', name: 'Style 2 (Terang)' },
            { url: 'https://picsum.photos/seed/gki3/600/800', name: 'Style 3' },
            { url: 'https://picsum.photos/seed/gki4/600/800', name: 'Style 4' },
            { url: 'https://picsum.photos/seed/gki5/600/800', name: 'Style 5' },
            { url: 'https://picsum.photos/seed/gki6/600/800', name: 'Style 6' },
        ];

        document.addEventListener('DOMContentLoaded', () => {
            initUI();
            initEvents();
            
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);

            // Coba load logo dari relative path
            loadImage(PERMANENT_LOGO_URL).then(img => {
                state.logo = img;
                state.logoLoaded = true;
                draw(); 
            }).catch(() => {
                console.warn("Logo gagal dimuat dari Relative Path. Silakan upload manual.");
                // Biarkan fallback canvas menggambar text placeholder jika belum ada logo manual
                draw();
            });

            // Load default frame
            loadFrame(frames[0].url).then(() => draw());
        });

        function toggleColorInput() {
            const checkbox = document.getElementById('autoColorCheck');
            const picker = document.getElementById('customColorPicker');
            if(checkbox.checked) {
                picker.classList.add('hidden');
                state.autoColor = true;
            } else {
                picker.classList.remove('hidden');
                state.autoColor = false;
                state.customColor = picker.value;
            }
            draw();
        }

        function initUI() {
            const container = document.getElementById('framePresets');
            if(!container) return;

            frames.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = `preset-option ${i===0 ? 'active' : ''}`;
                div.onclick = () => {
                    resetFrameSelection();
                    const label = document.getElementById('customFrameName');
                    if(label) label.textContent = "Menggunakan Preset";
                    
                    document.querySelectorAll('.preset-option').forEach(e => e.classList.remove('active'));
                    div.classList.add('active');
                    loadFrame(f.url).then(draw);
                };
                const img = document.createElement('img');
                img.src = f.url;
                div.appendChild(img);
                container.appendChild(div);
            });
        }

        function initEvents() {
            const addListener = (id, event, handler) => {
                const el = document.getElementById(id);
                if(el) el.addEventListener(event, handler);
            };

            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', () => {
                    updateData();
                    requestAnimationFrame(draw);
                });
            });

            // Color Picker Change
            addListener('customColorPicker', 'input', (e) => {
                state.customColor = e.target.value;
                draw();
            });

            addListener('serviceType', 'change', (e) => {
                toggleSections(e.target.value);
                updateData();
                draw();
            });

            addListener('btnLoadUrl', 'click', () => {
                const input = document.getElementById('frameUrlInput');
                if(input && input.value) {
                    resetFrameSelection();
                    const label = document.getElementById('customFrameName');
                    if(label) label.textContent = "Menggunakan Link URL";
                    loadFrame(input.value).then(draw).catch(() => showToast("Gagal memuat URL (Cek koneksi link)", "error"));
                }
            });

            addListener('customFrame', 'change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                const label = document.getElementById('customFrameName');
                if(label) label.textContent = file.name;

                resetFrameSelection();

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        state.frame = img;
                        state.isCustomFrame = true;
                        draw();
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            });

            // Manual Logo Upload
            addListener('logoFile', 'change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                const label = document.getElementById('logoFileName');
                if(label) label.textContent = file.name;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        state.logo = img;
                        state.logoLoaded = true;
                        draw();
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            });

            addListener('downloadBtn', 'click', () => {
                try {
                    const link = document.createElement('a');
                    link.download = `Flyer-GKI-${state.type}-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showToast("Berhasil diunduh!", "success");
                } catch(e) {
                    showToast("Gagal unduh (Browser Security)", "error");
                }
            });

            addListener('resetBtn', 'click', () => location.reload());
        }

        function resetFrameSelection() {
            state.isCustomFrame = false;
            const input = document.getElementById('frameUrlInput');
            if(input) input.value = "";
            document.querySelectorAll('.preset-option').forEach(el => el.classList.remove('active'));
        }

        function toggleSections(type) {
            document.querySelectorAll('.dynamic-section').forEach(el => el.classList.add('hidden'));
            if (type === 'umum') document.getElementById('section-umum').classList.remove('hidden');
            else if (type === 'remaja' || type === 'dewasa') document.getElementById('section-remaja-dewasa').classList.remove('hidden');
            else if (type === 'rt' || type === 'syukur') document.getElementById('section-rt-syukur').classList.remove('hidden');
            state.type = type;
        }

        function updateData() {
            const val = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };

            if (state.type === 'umum') {
                state.data = { date: formatDate(val('dateUmum')), w1: val('waktu1'), w2: val('waktu2'), tema: val('temaUmum'), pelayan: val('pelayanUmum'), asal: val('asalGerejaUmum') };
            } else if (['remaja', 'dewasa'].includes(state.type)) {
                state.data = { date: formatDate(val('dateRD')), w: val('waktuRD'), tema: val('temaRD'), pelayan: val('pelayanRD'), asal: val('asalGerejaRD') };
            } else {
                state.data = { date: formatDate(val('dateRT')), w: val('waktuRT'), wilayah: val('wilayahRT'), keluarga: val('namaKeluarga'), alamat: val('alamatRT'), pelayan: val('pelayanRT') };
            }
        }

        function formatDate(str) {
            if(!str) return '';
            const d = new Date(str);
            const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
            const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agt','Sep','Okt','Nov','Des'];
            return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        }

        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                if(url.startsWith('http')) img.crossOrigin = "Anonymous";
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = url;
            });
        }

        function loadFrame(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    state.frame = img;
                    resolve();
                };
                img.onerror = () => reject(new Error("Gagal memuat frame"));
                img.src = url;
            });
        }

        function getContrastColor(imgElement) {
            const c = document.createElement('canvas');
            const cx = c.getContext('2d');
            c.width = 1; c.height = 1;
            cx.drawImage(imgElement, W/2, H/2, 1, 1, 0, 0, 1, 1); 
            const p = cx.getImageData(0,0,1,1).data; 
            const brightness = (p[0]*299 + p[1]*587 + p[2]*114) / 1000;
            return brightness > 128 ? 'dark' : 'light';
        }

        function draw() {
            ctx.clearRect(0,0,W,H);
            if(state.frame) {
                ctx.drawImage(state.frame, 0,0,W,H);
                const contrast = getContrastColor(state.frame);
                if (contrast === 'light') {
                    ctx.fillStyle = 'rgba(255,255,255,0.0)'; 
                } else {
                    ctx.fillStyle = 'rgba(0,0,0,0.55)';
                }
                ctx.fillRect(0,0,W,H);
                state.contrast = contrast;
            } else {
                ctx.fillStyle = '#ccc';
                ctx.fillRect(0,0,W,H);
                state.contrast = 'dark';
            }

            // Tentukan Warna Teks
            let mainColor, subColor;

            if (state.autoColor) {
                // Logika Otomatis (Smart Contrast)
                mainColor = state.contrast === 'light' ? '#003366' : '#ffffff';
                subColor = state.contrast === 'light' ? '#555555' : '#dddddd';
            } else {
                // Logika Manual (User Color)
                mainColor = state.customColor;
                // Untuk warna secondary, buat sedikit transparan atau hitam/putih tergantung main color
                // Tapi untuk simplifikasi, kita gunakan warna manual dengan opacity
                // Atau kita ikut kontras frame agar box tetap enak dilihat?
                // Mari kita gunakan warna manual 80% opacity untuk subColor agar serasi.
                subColor = state.contrast === 'light' ? '#666666' : '#cccccc'; 
            }

            // Logo
            if(state.logoLoaded && state.logo) {
                const size = 150;
                const x = W/2 - size/2;
                const y = 100;
                ctx.fillStyle = 'rgba(255,255,255,0.9)';
                ctx.beginPath();
                ctx.roundRect(x-10, y-10, size+20, size+20, 20);
                ctx.fill();
                ctx.drawImage(state.logo, x, y, size, size);
            } else if (!state.logoLoaded) {
                const size = 150;
                const x = W/2 - size/2;
                const y = 100;
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(W/2, y + size/2, size/2, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = '#004aad';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText("LOGO", W/2, y + size/2 + 7);
                ctx.fillText("GKI", W/2, y + size/2 + 30);
            }

            let yPos = 320;

            ctx.textAlign = 'center';
            ctx.fillStyle = mainColor;
            ctx.font = 'bold 52px "Segoe UI"';
            
            // Jika manual color, shadow perlu diatur biar terbaca di frame terang/gelap
            if (!state.autoColor) {
                ctx.shadowColor = (state.contrast === 'light') ? "rgba(0,0,0,0.5)" : "rgba(255,255,255,0.8)";
                ctx.shadowBlur = 5;
            } else {
                ctx.shadowColor = (state.contrast === 'light') ? "rgba(255,255,255,0.8)" : "rgba(0,0,0,0.8)";
                ctx.shadowBlur = (state.contrast === 'light') ? 5 : 10;
            }
            
            ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0;
            
            if(state.contrast === 'light' && state.autoColor) {
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'white';
                ctx.strokeText(state.churchName.toUpperCase(), W/2, yPos);
            }
            ctx.fillText(state.churchName.toUpperCase(), W/2, yPos);
            ctx.shadowBlur=0;

            yPos += 40;
            ctx.beginPath();
            ctx.moveTo(W/2-100, yPos); ctx.lineTo(W/2+100, yPos);
            ctx.strokeStyle = mainColor;
            ctx.lineWidth = 3;
            ctx.stroke();

            yPos += 80;
            ctx.font = 'bold 65px "Segoe UI"';
            let title = "";
            if(state.type === 'umum') title = "KEBAKTIAN UMUM";
            else if(state.type === 'remaja') title = "KEBAKTIAN REMAJA PEMUDA";
            else if(state.type === 'dewasa') title = "PERSEKUTUAN DEWASA";
            else if(state.type === 'rt') title = "KEBAKTIAN RUMAH TANGGA";
            else if(state.type === 'syukur') title = "KEBAKTIAN SYUKUR";
            
            ctx.fillStyle = mainColor;
            ctx.fillText(title, W/2, yPos);

            yPos += 80;
            if(['rt','syukur'].includes(state.type)) ctx.font = 'bold 55px "Segoe UI"';
            else ctx.font = '40px "Segoe UI"';
            ctx.fillText(state.data.date, W/2, yPos);

            yPos += 60;
            ctx.font = 'bold 48px "Segoe UI"';
            if(state.type === 'umum') {
                ctx.fillText(`Kebaktian I: ${state.data.w1}`, W/2, yPos);
                yPos += 55;
                ctx.fillText(`Kebaktian II: ${state.data.w2}`, W/2, yPos);
            } else {
                ctx.fillText(`Pukul: ${state.data.w}`, W/2, yPos);
            }

            if (!['rt', 'syukur'].includes(state.type)) {
                yPos += 70;
                ctx.font = 'italic 42px "Times New Roman"';
                ctx.fillStyle = subColor;
                ctx.fillText(`"${state.data.tema}"`, W/2, yPos);
                yPos += 60;
            } else {
                yPos += 40;
            }

            yPos += 40;
            const boxX = 100, boxW = W-200, boxH = (['rt','syukur'].includes(state.type) ? 400 : 320);
            
            // Box Style Mengikuti SubColor agar lembut
            ctx.fillStyle = (state.contrast === 'light') ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.15)';
            ctx.strokeStyle = (state.contrast === 'light') ? 'rgba(0,0,0,0.4)' : 'rgba(255,255,255,0.6)';
            
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(boxX, yPos, boxW, boxH, 25);
            ctx.fill();
            ctx.stroke();

            yPos += 40;
            ctx.fillStyle = mainColor;
            
            if(['rt','syukur'].includes(state.type)) {
                ctx.font = '38px "Segoe UI"';
                yPos = wrapText(ctx, `Wilayah: ${state.data.wilayah}`, boxX+40, yPos, boxW-80, 48);
                yPos += 10;
                ctx.font = 'bold 45px "Segoe UI"';
                yPos = wrapText(ctx, state.data.keluarga, boxX+40, yPos, boxW-80, 55);
                yPos += 10;
                ctx.font = '38px "Segoe UI"';
                yPos = wrapText(ctx, `üìç ${state.data.alamat}`, boxX+40, yPos, boxW-80, 48);
                yPos += 50;
                ctx.font = '35px "Segoe UI"';
                ctx.fillText(`Pelayan Firman: ${state.data.pelayan}`, W/2, yPos);
            } else {
                ctx.font = '38px "Segoe UI"';
                ctx.fillText("Pelayan Firman:", W/2, yPos);
                yPos += 60;
                ctx.font = 'bold 60px "Segoe UI"';
                yPos = wrapText(ctx, state.data.pelayan, boxX+40, yPos, boxW-80, 65);
                if(state.data.asal) {
                    yPos += 10; 
                    ctx.font = '38px "Segoe UI"';
                    ctx.fillStyle = subColor;
                    ctx.fillText(`(${state.data.asal})`, W/2, yPos);
                }
            }

            ctx.fillStyle = subColor;
            ctx.font = '30px "Segoe UI"';
            ctx.fillText("www.gkigriyamerpatimas.or.id", W/2, H-100);
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let currentY = y;
            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    ctx.fillText(line, x + maxWidth/2, currentY);
                    line = words[n] + ' ';
                    currentY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x + maxWidth/2, currentY);
            return currentY + lineHeight;
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            if(!t) return;
            t.textContent = msg;
            t.style.background = type === 'success' ? '#28a745' : '#dc3545';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>