<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator E-flyer GKI Griya Merpati Mas</title>
    <link rel="icon" href="data:,">
    
    <style>
        :root {
            --primary-color: #004aad;
            --secondary-color: #f5f7fa;
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --pexels-color: #05A081; 
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--secondary-color); color: var(--text-color); line-height: 1.6; padding: 20px; }
        
        header { text-align: center; margin-bottom: 30px; }
        header h1 { color: var(--primary-color); margin-bottom: 5px; font-size: 1.8rem; }
        header p { color: #666; font-size: 0.9rem; }

        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

        /* Panel Kontrol */
        .control-panel { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; position: relative; } /* Added relative for dropdown positioning */
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; }

        /* Buttons */
        .btn { display: inline-block; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; text-decoration: none; text-align: center; width: 100%; }
        
        .btn-pexels { background: var(--pexels-color); color: white; margin-bottom: 10px; }
        .btn-pexels:hover { background: '#048067'; }

        .btn-primary { background: var(--primary-color); color: white; margin-top: 5px;}
        .btn-primary:hover { background: #003380; }
        
        .file-upload-wrapper { margin-bottom: 10px; border: 1px dashed #ccc; padding: 10px; border-radius: 8px; background: #fafafa; }
        .file-upload-label { display: inline-block; padding: 6px 12px; background: #555; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        input[type="file"] { display: none; }
        input[type="color"] { height: 40px; padding: 2px; cursor: pointer; }
        .file-name-display { font-size: 0.8rem; color: #555; margin-top: 5px; }

        /* Preset Grid */
        .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .preset-option { border: 2px solid transparent; border-radius: 6px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .preset-option:hover { transform: scale(1.02); }
        .preset-option.active { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 74, 173, 0.3); }
        .preset-option img { width: 100%; height: 70px; object-fit: cover; display: block; }

        /* Preview */
        .preview-panel { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; position: sticky; top: 20px; }
        .canvas-container { width: 100%; max-width: 500px; border: 1px solid #eee; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; aspect-ratio: 3/4; background: #f9f9f9; }
        canvas { width: 100%; height: 100%; display: block; }

        .action-buttons { display: flex; gap: 15px; width: 100%; }
        .btn-action { flex: 1; padding: 12px; font-size: 1rem; border-radius: 6px; border:none; cursor: pointer; font-weight: 600; }
        .btn-dl { background: var(--success-color); color: white; }
        .btn-rst { background: #6c757d; color: white; }

        .hidden { display: none; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 24px; border-radius: 6px; opacity: 0; transition: opacity 0.3s; z-index: 1000; max-width: 300px; text-align: center; font-size: 0.9rem;}
        .toast.show { opacity: 1; }

        /* Search Dropdown Styling */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .search-item {
            padding: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid #eee;
        }
        .search-item:hover { background-color: #f0f7ff; }
        .search-item b { color: var(--primary-color); }
        .search-item .church-name { display: block; font-size: 0.75rem; color: #666; }
    </style>
</head>
<body>

    <header>
        <h1>Generator E-flyer Kebaktian</h1>
        <p>GKI Griya Merpati Mas</p>
    </header>

    <div class="container">
        <!-- Kolom Input -->
        <section class="control-panel">
            <form id="flyerForm">
                
                <!-- 1. Desain -->
                <h3>1. Pengaturan Desain</h3>
                <hr style="margin: 10px 0 20px; border: 0; border-top: 1px solid #eee;">
                
                <!-- Logo Section -->
                <!-- Warna Teks Section -->
                <div class="form-group">
                    <label>Warna Teks Utama</label>
                    <label style="font-weight:normal; font-size:0.85rem; margin-bottom:5px;">
                        <input type="checkbox" id="autoColorCheck" checked onchange="toggleColorInput()"> 
                        Warna Otomatis (Sesuaikan dengan Frame)
                    </label>
                    <input type="color" id="customColorPicker" class="form-control hidden" value="#ffffff" title="Pilih warna custom">
                </div>

                <!-- Frame Section -->
                <div class="form-group">
                    <!-- Upload Custom Frame -->
                    <div class="file-upload-wrapper">
                        <label for="customFrame" class="file-upload-label">Upload Bingkai/Background Sendiri (File)</label>
                        <input type="file" id="customFrame" accept="image/*">
                        <div id="customFrameName" class="file-name-display">Jika Link gagal, gunakan upload file</div>
                    </div>
                </div>

                <!-- Presets -->
                <label>Pilihan Preset:</label>
                <div class="preset-grid" id="framePresets"></div>

                <br>
                <!-- 2. Detail Kebaktian -->
                <h3>2. Detail Acara</h3>
                <hr style="margin: 10px 0 20px; border: 0; border-top: 1px solid #eee;">

                <div class="form-group">
                    <label for="serviceType">Jenis Kebaktian</label>
                    <select id="serviceType" class="form-control">
                        <option value="umum">Kebaktian Umum</option>
                        <option value="remaja">Kebaktian Remaja - Pemuda</option>
                        <option value="praremaja">Kebaktian Pra Remaja</option>
                        <option value="dewasa">Persekutuan Dewasa</option>
                        <option value="sekolahminggu">Kebaktian Sekolah Minggu</option>
                        <option value="rt">Kebaktian Rumah Tangga</option>
                        <option value="syukur">Kebaktian Syukur</option>
                    </select>
                </div>

                <!-- Fields Umum -->
                <div id="section-umum" class="dynamic-section">
                    <div class="form-group"><label>Tanggal</label><input type="date" id="dateUmum" class="form-control"></div>
                    <div class="form-group"><label>Waktu Kebaktian I</label><input type="text" id="waktu1" class="form-control" value="07.00 WIB"></div>
                    <div class="form-group"><label>Waktu Kebaktian II</label><input type="text" id="waktu2" class="form-control" value="09.00 WIB"></div>
                    <div class="form-group"><label>Tema</label><input type="text" id="temaUmum" class="form-control" value="Kasih Karunia yang Memulihkan"></div>
                    
                    <div class="form-group">
                        <label>Pelayan Firman (Cari Nama)</label>
                        <input type="text" id="pelayanUmum" class="form-control" placeholder="Ketik nama pelayan..." autocomplete="off">
                        <!-- Dropdown container will be injected here -->
                    </div>

                    <div class="form-group"><label>Asal Gereja</label><input type="text" id="asalGerejaUmum" class="form-control" value="GKI Griya Merpati Mas" readonly></div>
                    
                    <div class="form-group"><label>Keterangan (Optional)</label><input type="text" id="keteranganUmum" class="form-control" placeholder="Contoh: Wajib Memakai Masker"></div>
                </div>

                <!-- Fields Remaja / Dewasa -->
                <div id="section-remaja-dewasa" class="dynamic-section hidden">
                    <div class="form-group"><label>Tanggal</label><input type="date" id="dateRD" class="form-control"></div>
                    <div class="form-group"><label>Waktu</label><input type="text" id="waktuRD" class="form-control" value="11.00 WIB"></div>
                    <div class="form-group"><label>Tema</label><input type="text" id="temaRD" class="form-control" value="Berani Beda"></div>
                    
                    <div class="form-group">
                        <label>Pelayan Firman (Cari Nama)</label>
                        <input type="text" id="pelayanRD" class="form-control" placeholder="Ketik nama pelayan..." autocomplete="off">
                    </div>

                    <div class="form-group"><label>Asal Gereja</label><input type="text" id="asalGerejaRD" class="form-control" value="GKI Griya Merpati Mas" readonly></div>
                </div>

                <!-- Fields Pra Remaja -->
                <div id="section-praremaja" class="dynamic-section hidden">
                    <div class="form-group"><label>Jenis Kebaktian (Judul)</label><input type="text" id="judulPra" class="form-control" value="IBADAH BULANAN"></div>
                    <div class="form-group"><label>Tanggal</label><input type="date" id="datePra" class="form-control"></div>
                    <div class="form-group"><label>Waktu</label><input type="text" id="waktuPra" class="form-control" value="10.00 WIB"></div>
                    <div class="form-group"><label>Tema</label><input type="text" id="temaPra" class="form-control" value="Anak yang Diberkati"></div>
                </div>

                <!-- Fields Sekolah Minggu -->
                <div id="section-sekolahminggu" class="dynamic-section hidden">
                    <div class="form-group"><label>Jenis Kebaktian (Judul)</label><input type="text" id="judulSM" class="form-control" value="IBADAH SEKOLAH MINGGU"></div>
                    <div class="form-group"><label>Tanggal</label><input type="date" id="dateSM" class="form-control"></div>
                    <div class="form-group"><label>Waktu Kelas Batita - 3</label><input type="text" id="waktuSM1" class="form-control" value="09.00 WIB"></div>
                    <div class="form-group"><label>Waktu Kelas 4 - 8</label><input type="text" id="waktuSM2" class="form-control" value="10.30 WIB"></div>
                    <div class="form-group"><label>Tema</label><input type="text" id="temaSM" class="form-control" value="Yesus Sahabat Kita"></div>
                </div>

                <!-- Fields RT / Syukur -->
                <div id="section-rt-syukur" class="dynamic-section hidden">
                    <div class="form-group"><label>Tanggal</label><input type="date" id="dateRT" class="form-control"></div>
                    <div class="form-group"><label>Waktu</label><input type="text" id="waktuRT" class="form-control" value="18.00 WIB"></div>
                    <div class="form-group"><label>Wilayah / Area</label><input type="text" id="wilayahRT" class="form-control" value="Wilayah Blok A"></div>
                    <div class="form-group"><label>Nama Keluarga / Host</label><input type="text" id="namaKeluarga" class="form-control" value="Klg. Bpk. Budi"></div>
                    <div class="form-group"><label>Alamat</label><input type="text" id="alamatRT" class="form-control" value="Jl. Damai Sejahtera No. 12"></div>
                    
                    <div class="form-group">
                        <label>Pelayan Firman (Cari Nama)</label>
                        <input type="text" id="pelayanRT" class="form-control" placeholder="Ketik nama pelayan..." autocomplete="off">
                    </div>
                    
                    <!-- Added Asal Gereja for RT so the feature works there too -->
                    <div class="form-group"><label>Asal Gereja Pelayan</label><input type="text" id="asalGerejaRT" class="form-control" readonly></div>
                </div>

            </form>
        </section>

        <!-- Kolom Preview -->
        <section class="preview-panel">
            <h3>Pratinjau</h3>
            <div class="canvas-container">
                <canvas id="flyerCanvas"></canvas>
            </div>
            <div class="action-buttons">
                <button type="button" class="btn-action btn-rst" id="resetBtn">Reset</button>
                <button type="button" class="btn-action btn-dl" id="downloadBtn">Unduh Gambar</button>
            </div>
        </section>
    </div>

    <div id="toast" class="toast">Notifikasi</div>

    <script>
        /**
         * DATA PELAYAN FIRMAN (DATABASE)
         * Data diambil dari daftar yang diberikan user
         */
        const preacherList = [
            {name:"Bpk. Ray James Sahertian, S.Si.(Teol.)", church:"BPK Penabur"},{name:"Pdt. A. Lung (Siau A Lung)", church:"GKI Rahmani"},{name:"Pdt. Abdiel Bhopa Djentoro", church:"GKI Ayudia"},{name:"Pdt. Addi Soselia Patriabara", church:"GKI Kavling Polri"},{name:"Pdt. Adi Cahyono", church:"GKI Delima"},{name:"Pdt. Adi Netto Kristanto", church:"GKI Kedoya"},{name:"Pdt. Agetta Putri Awijaya", church:"GKI Bandar Lampung"},{name:"Pdt. Agnes Irmawati Sunjoto", church:"GKI Kebonjati"},{name:"Pdt. Agus Gunawan", church:"GKI Kebonjati"},{name:"Pdt. Albert Marchus Puntodewo", church:"GKI Cikarang"},{name:"Pdt. Albertus Marines Patty", church:"GKI Maulana Yusuf"},{name:"Pdt. Alexander Hendrik Urbinas", church:"GKI Harapan Jaya"},{name:"Pdt. Alviandito Yulian Dicky", church:"GKI Kebonjati"},{name:"Pdt. Andi", church:"GKI Kanaan"},{name:"Pdt. Andi Christianto", church:"GKI Cawang"},{name:"Pdt. Andreas Loanka", church:"GKI Gading Serpong"},{name:"Pdt. Andy Gunawan", church:"GKI Bungur"},{name:"Pdt. Anthonius Widjaja", church:"GKI Duta Mas Batam"},{name:"Pdt. Arliyanus Larosa", church:"GKI Kepa Duri"},{name:"Pdt. Armin Honggo", church:"GKI Pekanbaru"},{name:"Pdt. Arum Agung Gumilar", church:"GKI Cianjur"},{name:"Pdt. Astrida Kardina", church:"GKI Cimahi"},{name:"Pdt. Ayunistya Dwita Prawira", church:"GKI Kayu Putih"},{name:"Pdt. Bagus Walujo Djati", church:"GKI Raya Hankam"},{name:"Pdt. Bambang Mulyono", church:"GKI Sudirman"},{name:"Pdt. Benny Halim", church:"GKI Serang"},{name:"Pdt. Bernadeth Florenza Da Lopez", church:"GKI Maulana Yusuf"},{name:"Pdt. Budiman", church:"GKI Bandar Lampung"},{name:"Pdt. Cenglyson Tjajadi", church:"GKI Anugerah"},{name:"Pdt. Charliedus Rounaldy Saragih Napitu", church:"GKI Camar"},{name:"Pdt. Christia Kalff", church:"GKI Layur"},{name:"Pdt. Christian Elbert Budiman", church:"GKI Wahid Hasyim"},{name:"Pdt. Christina Febri Untari Ospara", church:"GKI Kranggan"},{name:"Pdt. Cipta Martalu Sapangi", church:"GKI Puri Indah"},{name:"Pdt. Cordelia", church:"GKI Puri Indah"},{name:"Pdt. Daniel Guntur Cahyo Prakoso", church:"GKI Melur"},{name:"Pdt. Danny Purnama", church:"GKI Gading Serpong"},{name:"Pdt. Darmawasih Manullang", church:"GKI Kranggan"},{name:"Pdt. Darwin Darmawan", church:"Ptks Sinode GKI (Sekretaris Umum Pgi)"},{name:"Pdt. Daud Chevi Naibaho", church:"GKI Cikarang"},{name:"Pdt. Daud Solichin", church:"GKI Kebonjati"},{name:"Pdt. David Roestandi Surya S.", church:"GKI Kota Wisata"},{name:"Pdt. David Sudarto", church:"GKI Gunung Sahari"},{name:"Pdt. Debora Rachelina Stefani", church:"GKI Kota Wisata"},{name:"Pdt. Devina Erlin Minerva Marunduri", church:"GKI Gading Serpong"},{name:"Pdt. Dewi Prahesti", church:"GKI Wahid Hasyim"},{name:"Pdt. Diana Bachri", church:"GKI Cipinang Elok"},{name:"Pdt. Dimas Samuel", church:"GKI Terate"},{name:"Pdt. Dina Kharismaningtyas Budiasri", church:"GKI Re Martadinata"},{name:"Pdt. Djie S. Mahonny", church:"GKI Filadelfia"},{name:"Pdt. Eddo Ega Wirakusuma", church:"GKI Guntur"},{name:"Pdt. Edwin Nugraha Tjandraputra", church:"GKI Puri Indah"},{name:"Pdt. Eko Priliadona", church:"GKI Tanggamus Gisting"},{name:"Pdt. Em. Mulia Hukum Baeha Waruwu", church:"GKI Tubagus Angke"},{name:"Pdt. Em. Udjang Tanusaputra", church:"GKI Cimahi"},{name:"Pdt. Engeline Chandra", church:"GKI Kepa Duri"},{name:"Pdt. Erma Primastuti Kristiyono", church:"GKI Gading Serpong"},{name:"Pdt. Esakatri Parahita", church:"GKI Pengadilan Bogor"},{name:"Pdt. Essy Eisen", church:"GKI Halimun"},{name:"Pdt. Evelyne Yudiarti", church:"GKI Kedoya"},{name:"Pdt. Febe Oriana Fermanto", church:"GKI Gunung Sahari"},{name:"Pdt. Febrita Melati S.", church:"GKI Cikarang"},{name:"Pdt. Frida Situmorang", church:"GKI Samanhudi"},{name:"Pdt. Galvin Tiara Bartianus", church:"GKI Pengadilan Bogor"},{name:"Pdt. Gloria Tesalonika", church:"GKI Citra I"},{name:"Pdt. Gordon Suhardo Hutabarat", church:"GKI Kota Wisata"},{name:"Pdt. Gunawan Saputra", church:"GKI Pakis Raya"},{name:"Pdt. Handri", church:"GKI Cipinang Elok"},{name:"Pdt. Harianto Suryadi", church:"GKI Harapan Indah"},{name:"Pdt. Hendra Setia Prasaja", church:"GKI Camar"},{name:"Pdt. Hendri Mulyana Sendjaja", church:"GKI Samanhudi"},{name:"Pdt. Hendy Suwandi", church:"GKI Harapan Indah"},{name:"Pdt. Henni Herlina", church:"GKI Agus Salim"},{name:"Pdt. Hizkia Anugrah Gunawan", church:"GKI Taman Aries"},{name:"Pdt. Ima Frontatina Simamora", church:"GKI Delima"},{name:"Pdt. Iman Sugio Ibrahim", church:"GKI Kranggan"},{name:"Pdt. Imanuel Adam", church:"GKI Wahid Hasyim"},{name:"Pdt. Imanuel Kristo", church:"GKI Gunung Sahari"},{name:"Pdt. Indra Kurniadi Tjandra", church:"GKI Kota Modern"},{name:"Pdt. Indriyati Tjandra", church:"GKI Kosambi Baru"},{name:"Pdt. Ivonne Maranatha", church:"GKI Bekasi Timur"},{name:"Pdt. Iwan Sentoso", church:"GKI Guntur"},{name:"Pdt. Jimmi Santoso", church:"GKI Raya Hankam"},{name:"Pdt. Johan Newton Crystal Na", church:"GKI Duta Mas Batam"},{name:"Pdt. Jotje Hanri Karuh", church:"GKI Kebonjati"},{name:"Pdt. Juswantori Ichwan", church:"GKI Samanhudi"},{name:"Pdt. Kristina Simaremare", church:"GKI Samanhudi"},{name:"Pdt. Lie Nah", church:"GKI Perniagaan"},{name:"Pdt. Lie Samuel Wiratama", church:"GKI Citra Raya"},{name:"Pdt. Lie Simon Stevi", church:"GKI Agape"},{name:"Pdt. Lukman Sitorus", church:"GKI Penginjil"},{name:"Pdt. Luther Tarlim Samara", church:"GKI Zaenal Zahse"},{name:"Pdt. Lydia Novellia", church:"GKI Kanaan"},{name:"Pdt. Maria Waryanti Sindhu Putri", church:"GKI Samanhudi"},{name:"Pdt. Martinus Stephanus", church:"GKI Karbela"},{name:"Pdt. Marto Marbun", church:"GKI Perniagaan"},{name:"Pdt. Melani Ayub Egne", church:"GKI Agus Salim"},{name:"Pdt. Merry Rumondang Malau", church:"GKI Gunung Sahari"},{name:"Pdt. Michael Chandra Wijaya", church:"GKI Nurdin"},{name:"Pdt. Michael Suryajaya", church:"GKI Seroja"},{name:"Pdt. Modi Tiko Pradana", church:"GKI Cibadak"},{name:"Pdt. Mulyadi", church:"GKI Muara Karang"},{name:"Pdt. Nadya Dewi Natalia", church:"GKI Gatot Subroto"},{name:"Pdt. Nanang", church:"GKI Mangga Besar"},{name:"Pdt. Natan Kristiyanto", church:"GKI Kayu Putih"},{name:"Pdt. Natanael Setiadi", church:"GKI Kayu Putih"},{name:"Pdt. Naya Widiawan", church:"GKI Citra I"},{name:"Pdt. Noerman Sasono", church:"GKI Halimun"},{name:"Pdt. Novita", church:"GKI Gading Indah"},{name:"Pdt. Nugraha Yudhi Rumpaka", church:"GKI Bintaro"},{name:"Pdt. Nugraheni Iswara Adi", church:"GKI Buaran"},{name:"Pdt. Nurkiana Simatupang", church:"GKI Bundasudi"},{name:"Pdt. Peter Abet Nego Wijaya", church:"GKI Samanhudi"},{name:"Pdt. Prioutomo", church:"GKI Cipinang Indah"},{name:"Pdt. Rahmadi Putra", church:"GKI Pasirkoja"},{name:"Pdt. Reefo Christy Panabunan", church:"GKI Bungur"},{name:"Pdt. Ricardo Sitorus", church:"GKI Kemang Pratama Bekasi"},{name:"Pdt. Rinto Tampubolon", church:"GKI Taman Aries"},{name:"Pdt. Riseida Novlia Pasaribu", church:"GKI Raya Hankam"},{name:"Pdt. Roy Alexander Surjanegara", church:"GKI Buaran"},{name:"Pdt. Rumenta Santyani Manurung", church:"GKI Griya Merpati Mas"},{name:"Pdt. Samuel", church:"GKI Cicurug"},{name:"Pdt. Santoni", church:"GKI Gading Serpong"},{name:"Pdt. Semuel Akihary", church:"GKI Samanhudi"},{name:"Pdt. Setiawati Sucipto", church:"GKI Surya Utama"},{name:"Pdt. Sonny Samuel Hasiholan Turnip", church:"GKI Bekasi Timur"},{name:"Pdt. Sosam Enidampra Zebua", church:"GKI Rengasdengklok"},{name:"Pdt. Stefani Sohilait", church:"GKI Pondok Makmur"},{name:"Pdt. Sthira Budhi Purwosuwito", church:"GKI Gading Indah"},{name:"Pdt. Suhud Setyo Wardono", church:"Sekum Bpms GKI"},{name:"Pdt. Sunar Birama", church:"GKI Kanaan"},{name:"Pdt. Suriawan Edhi", church:"GKI Bungur"},{name:"Pdt. Suryatie Ambarsari", church:"GKI Perumnas I"},{name:"Pdt. Susamsuri", church:"GKI Anugerah"},{name:"Pdt. Susi Juliana", church:"GKI Rahmani"},{name:"Pdt. Suta Prawira", church:"GKI Gunung Sahari"},{name:"Pdt. Sutanto Teddhy", church:"GKI Cimahi"},{name:"Pdt. Suto Tan", church:"GKI Agape"},{name:"Pdt. Theo Paulus Situmorang", church:"GKI Metro Lampung"},{name:"Pdt. Timur Citra Sari", church:"GKI Bekasi Timur"},{name:"Pdt. Tjen Benny", church:"GKI Pinangsia Gloria"},{name:"Pdt. Tri Santoso", church:"GKI Pengadilan Bogor"},{name:"Pdt. Ujun Junaedi", church:"GKI Guntur"},{name:"Pdt. Verawati", church:"GKI Cipinang Indah"},{name:"Pdt. Vince Ferdinan Markus", church:"GKI Sutopo"},{name:"Pdt. Vincenco Garuda Damara", church:"GKI Buaran"},{name:"Pdt. Wee Williyanto", church:"GKI Maulana Yusuf"},{name:"Pdt. Wendy Pratama Gouw", church:"GKI Jatinegara"},{name:"Pdt. Widya Astuti", church:"GKI Kosambi Timur"},{name:"Pdt. Windyarti Angelia", church:"GKI Kavling Polri"},{name:"Pdt. Yael Eka Hadiputeri", church:"GKI Muara Karang"},{name:"Pdt. Yanti Rusli", church:"GKI Cawang"},{name:"Pdt. Yedi Otniel Liline", church:"GKI Sunter"},{name:"Pdt. Yerusa Maria Agustini H.", church:"GKI Pakuwon"},{name:"Pdt. Yeryandri Wilson Tungga", church:"GKI Bundasudi"},{name:"Pdt. Yesie Irawan", church:"GKI Kayu Putih"},{name:"Pdt. Yolanda Pantou", church:"GKI Surya Utama"},{name:"Pdt. Yosafat Simatupang", church:"GKI Sudirman"},{name:"Pdt. Yusak Soleiman", church:"GKI Kayu Putih"},{name:"Pdt.Em. Adijanto Suryadi", church:"GKI Surya Utama"},{name:"Pdt.Em. Andar Ismail", church:"GKI Samanhudi"},{name:"Pdt.Em. Anderas Hadi Simeon", church:"GKI Bungur"},{name:"Pdt.Em. Asworo Pireno", church:"GKI Camar"},{name:"Pdt.Em. Benjamin Maleachi", church:"GKI Wahid Hasyim"},{name:"Pdt.Em. Budiono Adi Wibowo", church:"GKI Maulana Yusuf"},{name:"Pdt.Em. Daisy Lukman", church:"GKI Pinangsia Gloria"},{name:"Pdt.Em. Dede Soerja Moeljana", church:"GKI Buaran"},{name:"Pdt.Em. Dianawati Sarah Juwanda", church:"GKI Nurdin"},{name:"Pdt.Em. Ellisabeth", church:"GKI Citra I"},{name:"Pdt.Em. Elly Ledia Tehupeiory", church:"GKI Raya Hankam"},{name:"Pdt.Em. Faith Yuswandi", church:"GKI Pinangsia Gloria"},{name:"Pdt.Em. Ferdinand Suleeman", church:"GKI Bekasi Timur"},{name:"Pdt.Em. Flora Dharmawan", church:"GKI Gunung Sahari"},{name:"Pdt.Em. Grace Elim", church:"GKI Bungur"},{name:"Pdt.Em. Harry Gunawan", church:"GKI Ayudia"},{name:"Pdt.Em. Haryanto Wahyudi Maranatha", church:"GKI Nurdin"},{name:"Pdt.Em. Henkie Kertamihardja", church:"GKI Kepa Duri"},{name:"Pdt.Em. Henry Efferin", church:"GKI Anugerah"},{name:"Pdt.Em. Henry Rugun Tarigan Girsang", church:"GKI Kalideres"},{name:"Pdt.Em. Heryadi Atmasuyana", church:"GKI Sudirman"},{name:"Pdt.Em. Iwan Tri Wakhyudi", church:"GKI Samanhudi"},{name:"Pdt.Em. Jahja Purwanto", church:"GKI Pasirkaliki"},{name:"Pdt.Em. Jahja Sunarja", church:"GKI Puri Indah"},{name:"Pdt.Em. Jefta Chandra Widiatmadja", church:"GKI Samanhudi"},{name:"Pdt.Em. Jimmer L. G. Saragih", church:"GKI Sutopo"},{name:"Pdt.Em. Joppy Alexander Saerang", church:"GKI Anugerah"},{name:"Pdt.Em. Joseph The To Liong", church:"GKI Jatinegara"},{name:"Pdt.Em. Julius Kristianto", church:"GKI Melur"},{name:"Pdt.Em. Junatan Subianto", church:"GKI Samanhudi"},{name:"Pdt.Em. Kathleen Tan Kiuw Tin", church:"GKI Rahmani"},{name:"Pdt.Em. Liely S. Setiadi", church:"GKI Samanhudi"},{name:"Pdt.Em. Lucia Dahliana Widjaja", church:"GKI Samanhudi"},{name:"Pdt.Em. Luther Tan", church:"GKI Perniagaan"},{name:"Pdt.Em. Magdalena Handoyo", church:"GKI Pasirkaliki"},{name:"Pdt.Em. Matius T.Adi Prawira", church:"GKI Kanaan"},{name:"Pdt.Em. Maxi Sompotan", church:"GKI Re Martadinata"},{name:"Pdt.Em. Meitha Sartika", church:"GKI Delima"},{name:"Pdt.Em. Mellisa Sugihermanto", church:"GKI Terang Hidup"},{name:"Pdt.Em. Merry Sung", church:"GKI Penginjil"},{name:"Pdt.Em. Natan Setiabudi", church:"GKI Kedoya"},{name:"Pdt.Em. Nur Wahjuni Kristiadji", church:"GKI Perniagaan"},{name:"Pdt.Em. Nurhayati Girsang", church:"GKI Gunung Sahari"},{name:"Pdt.Em. Omo Hasim", church:"GKI Cikarang"},{name:"Pdt.Em. Paul Suradji", church:"GKI Cawang"},{name:"Pdt.Em. Peterus Nadjari", church:"GKI Terate"},{name:"Pdt.Em. Raden August Sehat Pandiangan", church:"GKI Perniagaan"},{name:"Pdt.Em. Rasid Rachman", church:"GKI Surya Utama"},{name:"Pdt.Em. Rewah Auriani Handayani S.", church:"GKI Pasirkaliki"},{name:"Pdt.Em. Robby I Gusti Chandra", church:"GKI Kayu Putih"},{name:"Pdt.Em. Ronny Nathanael", church:"GKI Gading Indah"},{name:"Pdt.Em. Ronny Setiamukti", church:"GKI Muara Karang"},{name:"Pdt.Em. Royandi Tanudjaya", church:"GKI Gunung Sahari"},{name:"Pdt.Em. Samuel Santoso", church:"GKI Kedoya"},{name:"Pdt.Em. Samuel Suryodinoto", church:"GKI Layur"},{name:"Pdt.Em. Semuel Obaja Purwadisatra", church:"GKI Wahid Hasyim"},{name:"Pdt.Em. Setiawan Oetama", church:"GKI Samanhudi"},{name:"Pdt.Em. Sheph Davidy Jonazh", church:"GKI Gunung Sahari"},{name:"Pdt.Em. Suatami Sutedja", church:"GKI Gading Indah"},{name:"Pdt.Em. Sugiarto Sutanto", church:"GKI Taman Aries"},{name:"Pdt.Em. Suryadi", church:"GKI Cikarang"},{name:"Pdt.Em. Suryadi Niman", church:"GKI Cipinang Indah"},{name:"Pdt.Em. Tonny Arwadi", church:"GKI Delima"},{name:"Pdt.Em. Tri Hiantoro", church:"GKI Kebonjati"},{name:"Pdt.Em. Willy Berlian", church:"GKI Duta Mas Batam"},{name:"Pnt. Ana Nur'Aini", church:"GKI Gading Indah"},{name:"Pnt. Frida Tri Jayanti", church:"GKI Kebonjati"},{name:"Pnt. Gabriela Nathania", church:"GKI Kalideres"},{name:"Pnt. Gilbert Christian Kristamulyana", church:"GKI Gunung Sahari"},{name:"Pnt. Harapan Panjaitan", church:"GKI Raya Hankam"},{name:"Pnt. Jefrry Aswin Hartanto", church:"GKI Sumbawa Dua"},{name:"Pnt. Liem Septian Adi Nugroho", church:"GKI Agus Salim"},{name:"Pnt. Marcello Ananda Odang", church:"GKI Layur"},{name:"Pnt. Novia Abigail", church:"GKI Sutopo"},{name:"Pnt. Theo Krispanki Dandel", church:"GKI Muara Karang"},{name:"Pnt. Yason Resyiworo Hyangputra", church:"GKI Sutopo"},{name:"Pnt. Yosafat Prasanda Hanaryo", church:"GKI Pamanukan"},{name:"Pnt. Zeta Dahana", church:"GKI Maulana Yusuf"},{name:"Sdr. David Ryantama Sitorus", church:"(Kader Kependetaan GKI) Praktik Jemaat 2 - GKI Sidoarjo"},{name:"Pdt. Boas Pepalem Tarigan", church:"GKI Palsigunung - Depok"},{name:"Pdt. Markus Hadinata", church:"GKI Perniagaan"},{name:"Pdt. Yonatan Wijayanto", church:"GKI Serpong"}
        ];

        /**
         * SETUP & CONSTANTS
         */
        const canvas = document.getElementById('flyerCanvas');
        const ctx = canvas.getContext('2d');
        const W = 1080, H = 1440;
        canvas.width = W;
        canvas.height = H;

        const PERMANENT_CHURCH_NAME = "GKI Griya Merpati Mas";
        const PERMANENT_LOGO_URL = "gki-gereja-kristen-indonesia-logo-png_seeklogo-536222.png";

        const state = {
            churchName: PERMANENT_CHURCH_NAME,
            logo: null, 
            logoLoaded: false,
            frame: null, 
            isCustomFrame: false,
            type: 'umum',
            data: {},
            autoColor: true,
            customColor: '#ffffff'
        };

        const frames = [
            { url: '21.png', name: 'Style 1' },
            { url: '22.png', name: 'Style 2' },
            { url: '23.png', name: 'Style 3' },
            { url: '24.png', name: 'Style 4' },
            { url: '25.png', name: 'Style 5' },
            { url: '26.png', name: 'Style 6' },
        ];

        document.addEventListener('DOMContentLoaded', () => {
            initUI();
            initEvents();
            initPreacherDropdowns();
            
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);

            loadImage(PERMANENT_LOGO_URL).then(img => {
                state.logo = img;
                state.logoLoaded = true;
                draw(); 
            }).catch(() => {
                console.warn("Logo gagal dimuat. Upload manual.");
                draw();
            });

            loadFrame(frames[0].url).then(() => draw());
        });

        function initPreacherDropdowns() {
            const maps = [
                { input: 'pelayanUmum', target: 'asalGerejaUmum' },
                { input: 'pelayanRD', target: 'asalGerejaRD' },
                { input: 'pelayanRT', target: 'asalGerejaRT' }
            ];

            maps.forEach(map => {
                const inputEl = document.getElementById(map.input);
                const targetEl = document.getElementById(map.target);
                if(inputEl && targetEl) {
                    setupSearch(inputEl, targetEl);
                }
            });
        }

        function setupSearch(inputEl, targetEl) {
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'search-results hidden';
            inputEl.parentNode.appendChild(resultsContainer);

            inputEl.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                resultsContainer.innerHTML = '';
                
                if (val.length < 2) {
                    resultsContainer.classList.add('hidden');
                    return;
                }

                const filtered = preacherList.filter(p => p.name.toLowerCase().includes(val));
                
                if (filtered.length > 0) {
                    filtered.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.innerHTML = `<b>${highlightMatch(p.name, val)}</b> <span class="church-name">${p.church}</span>`;
                        item.addEventListener('mousedown', () => {
                            inputEl.value = p.name;
                            targetEl.value = p.church;
                            resultsContainer.classList.add('hidden');
                            updateData();
                            draw();
                        });
                        resultsContainer.appendChild(item);
                    });
                    resultsContainer.classList.remove('hidden');
                } else {
                    resultsContainer.classList.add('hidden');
                }
            });

            // Hide when clicking outside
            document.addEventListener('click', (e) => {
                if (!inputEl.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.classList.add('hidden');
                }
            });
        }

        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span style="color:var(--primary-color)">$1</span>');
        }

        function toggleColorInput() {
            const checkbox = document.getElementById('autoColorCheck');
            const picker = document.getElementById('customColorPicker');
            if(checkbox.checked) {
                picker.classList.add('hidden');
                state.autoColor = true;
            } else {
                picker.classList.remove('hidden');
                state.autoColor = false;
                state.customColor = picker.value;
            }
            draw();
        }

        function initUI() {
            const container = document.getElementById('framePresets');
            if(!container) return;

            frames.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = `preset-option ${i===0 ? 'active' : ''}`;
                div.onclick = () => {
                    resetFrameSelection();
                    const label = document.getElementById('customFrameName');
                    if(label) label.textContent = "Menggunakan Preset";
                    
                    document.querySelectorAll('.preset-option').forEach(e => e.classList.remove('active'));
                    div.classList.add('active');
                    loadFrame(f.url).then(draw);
                };
                const img = document.createElement('img');
                img.src = f.url;
                div.appendChild(img);
                container.appendChild(div);
            });
        }

        function initEvents() {
            const addListener = (id, event, handler) => {
                const el = document.getElementById(id);
                if(el) el.addEventListener(event, handler);
            };

            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', () => {
                    updateData();
                    requestAnimationFrame(draw);
                });
            });

            addListener('customColorPicker', 'input', (e) => {
                state.customColor = e.target.value;
                draw();
            });

            addListener('serviceType', 'change', (e) => {
                toggleSections(e.target.value);
                updateData();
                draw();
            });

            addListener('btnLoadUrl', 'click', () => {
                const input = document.getElementById('frameUrlInput');
                if(input && input.value) {
                    resetFrameSelection();
                    const label = document.getElementById('customFrameName');
                    if(label) label.textContent = "Menggunakan Link URL";
                    loadFrame(input.value).then(draw).catch(() => {
                        showToast("Gagal (Gambar Diproteksi). Silakan Download & Upload Manual.", "error");
                    });
                }
            });

            addListener('customFrame', 'change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const label = document.getElementById('customFrameName');
                if(label) label.textContent = file.name;
                resetFrameSelection();

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        state.frame = img;
                        state.isCustomFrame = true;
                        draw();
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            });

            addListener('logoFile', 'change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const label = document.getElementById('logoFileName');
                if(label) label.textContent = file.name;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        state.logo = img;
                        state.logoLoaded = true;
                        draw();
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            });

            addListener('downloadBtn', 'click', () => {
                try {
                    const link = document.createElement('a');
                    link.download = `Flyer-GKI-${state.type}-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showToast("Berhasil diunduh!", "success");
                } catch(e) {
                    showToast("Gagal unduh (Browser Security)", "error");
                }
            });

            addListener('resetBtn', 'click', () => location.reload());
        }

        function resetFrameSelection() {
            state.isCustomFrame = false;
            const input = document.getElementById('frameUrlInput');
            if(input) input.value = "";
            document.querySelectorAll('.preset-option').forEach(el => el.classList.remove('active'));
        }

        function toggleSections(type) {
            document.querySelectorAll('.dynamic-section').forEach(el => el.classList.add('hidden'));
            if (type === 'umum') document.getElementById('section-umum').classList.remove('hidden');
            else if (type === 'remaja' || type === 'dewasa') document.getElementById('section-remaja-dewasa').classList.remove('hidden');
            else if (type === 'praremaja') document.getElementById('section-praremaja').classList.remove('hidden');
            else if (type === 'sekolahminggu') document.getElementById('section-sekolahminggu').classList.remove('hidden');
            else if (type === 'rt' || type === 'syukur') document.getElementById('section-rt-syukur').classList.remove('hidden');
            state.type = type;
        }

        function updateData() {
            const val = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };

            if (state.type === 'umum') {
                state.data = { 
                    date: formatDate(val('dateUmum')), 
                    w1: val('waktu1'), 
                    w2: val('waktu2'), 
                    tema: val('temaUmum'), 
                    pelayan: val('pelayanUmum'), 
                    asal: val('asalGerejaUmum'),
                    ket: val('keteranganUmum')
                };
            } else if (['remaja', 'dewasa'].includes(state.type)) {
                state.data = { date: formatDate(val('dateRD')), w: val('waktuRD'), tema: val('temaRD'), pelayan: val('pelayanRD'), asal: val('asalGerejaRD') };
            } else if (state.type === 'praremaja') {
                state.data = { judul: val('judulPra'), date: formatDate(val('datePra')), w: val('waktuPra'), tema: val('temaPra') };
            } else if (state.type === 'sekolahminggu') {
                state.data = { judul: val('judulSM'), date: formatDate(val('dateSM')), w1: val('waktuSM1'), w2: val('waktuSM2'), tema: val('temaSM') };
            } else {
                state.data = { date: formatDate(val('dateRT')), w: val('waktuRT'), wilayah: val('wilayahRT'), keluarga: val('namaKeluarga'), alamat: val('alamatRT'), pelayan: val('pelayanRT'), asal: val('asalGerejaRT') };
            }
        }

        function formatDate(str) {
            if(!str) return '';
            const d = new Date(str);
            const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
            const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agt','Sep','Okt','Nov','Des'];
            return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        }

        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                if(url.startsWith('http')) img.crossOrigin = "Anonymous";
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = url;
            });
        }

        function loadFrame(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    state.frame = img;
                    resolve();
                };
                img.onerror = () => reject(new Error("Gagal memuat frame"));
                img.src = url;
            });
        }

        function getContrastColor(imgElement) {
            const c = document.createElement('canvas');
            const cx = c.getContext('2d');
            c.width = 1; c.height = 1;
            cx.drawImage(imgElement, W/2, H/2, 1, 1, 0, 0, 1, 1); 
            const p = cx.getImageData(0,0,1,1).data; 
            const brightness = (p[0]*299 + p[1]*587 + p[2]*114) / 1000;
            return brightness > 128 ? 'dark' : 'light';
        }

        function draw() {
            ctx.clearRect(0,0,W,H);
            if(state.frame) {
                ctx.drawImage(state.frame, 0,0,W,H);
                const contrast = getContrastColor(state.frame);
                if (contrast === 'light') {
                    ctx.fillStyle = 'rgba(255,255,255,0.0)'; 
                } else {
                    ctx.fillStyle = 'rgba(0,0,0,0.55)';
                }
                ctx.fillRect(0,0,W,H);
                state.contrast = contrast;
            } else {
                ctx.fillStyle = '#ccc';
                ctx.fillRect(0,0,W,H);
                state.contrast = 'dark';
            }

            let mainColor, subColor;
            if (state.autoColor) {
                mainColor = state.contrast === 'light' ? '#003366' : '#ffffff';
                subColor = state.contrast === 'light' ? '#555555' : '#dddddd';
            } else {
                mainColor = state.customColor;
                subColor = state.contrast === 'light' ? '#666666' : '#cccccc'; 
            }

            if(state.logoLoaded && state.logo) {
                const size = 150;
                const x = W/2 - size/2;
                const y = 100;
                ctx.fillStyle = 'rgba(255,255,255,0.9)';
                ctx.beginPath();
                ctx.roundRect(x-10, y-10, size+20, size+20, 20);
                ctx.fill();
                ctx.drawImage(state.logo, x, y, size, size);
            } else if (!state.logoLoaded) {
                const size = 150;
                const x = W/2 - size/2;
                const y = 100;
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(W/2, y + size/2, size/2, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = '#004aad';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText("LOGO", W/2, y + size/2 + 7);
                ctx.fillText("GKI", W/2, y + size/2 + 30);
            }

            let yPos = 320;

            ctx.textAlign = 'center';
            ctx.fillStyle = mainColor;
            ctx.font = 'bold 52px "Segoe UI"';
            
            if (!state.autoColor) {
                ctx.shadowColor = (state.contrast === 'light') ? "rgba(0,0,0,0.5)" : "rgba(255,255,255,0.8)";
                ctx.shadowBlur = 5;
            } else {
                ctx.shadowColor = (state.contrast === 'light') ? "rgba(255,255,255,0.8)" : "rgba(0,0,0,0.8)";
                ctx.shadowBlur = (state.contrast === 'light') ? 5 : 10;
            }
            
            ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0;
            
            if(state.contrast === 'light' && state.autoColor) {
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'white';
                ctx.strokeText(state.churchName.toUpperCase(), W/2, yPos);
            }
            ctx.fillText(state.churchName.toUpperCase(), W/2, yPos);
            ctx.shadowBlur=0;

            yPos += 40;
            ctx.beginPath();
            ctx.moveTo(W/2-100, yPos); ctx.lineTo(W/2+100, yPos);
            ctx.strokeStyle = mainColor;
            ctx.lineWidth = 3;
            ctx.stroke();

            yPos += 80;
            ctx.font = 'bold 65px "Segoe UI"';
            let title = "";
            if(state.type === 'umum') title = "KEBAKTIAN UMUM";
            else if(state.type === 'remaja') title = "KEBAKTIAN REMAJA PEMUDA";
            else if(state.type === 'praremaja') title = state.data.judul.toUpperCase();
            else if(state.type === 'dewasa') title = "PERSEKUTUAN DEWASA";
            else if(state.type === 'sekolahminggu') title = state.data.judul.toUpperCase();
            else if(state.type === 'rt') title = "KEBAKTIAN RUMAH TANGGA";
            else if(state.type === 'syukur') title = "KEBAKTIAN SYUKUR";
            
            ctx.fillStyle = mainColor;
            ctx.fillText(title, W/2, yPos);

            yPos += 80;
            if(['rt','syukur'].includes(state.type)) ctx.font = 'bold 55px "Segoe UI"';
            else ctx.font = '40px "Segoe UI"';
            ctx.fillText(state.data.date, W/2, yPos);

            yPos += 60;
            ctx.font = 'bold 48px "Segoe UI"';
            
            if (state.type === 'sekolahminggu') {
                ctx.fillText(`Kelas Batita-3: ${state.data.w1}`, W/2, yPos);
                yPos += 55;
                ctx.fillText(`Kelas 4-8: ${state.data.w2}`, W/2, yPos);
            } else if (state.type === 'umum') {
                ctx.fillText(`Kebaktian I: ${state.data.w1}`, W/2, yPos);
                yPos += 55;
                ctx.fillText(`Kebaktian II: ${state.data.w2}`, W/2, yPos);
            } else {
                ctx.fillText(`Pukul: ${state.data.w}`, W/2, yPos);
            }

            if (!['rt', 'syukur'].includes(state.type)) {
                yPos += 70;
                ctx.font = 'italic 42px "Times New Roman"';
                ctx.fillStyle = subColor;
                ctx.fillText(`"${state.data.tema}"`, W/2, yPos);
                yPos += 60;
            } else {
                yPos += 40;
            }

            yPos += 40;
            let boxH = 320;
            if(['rt','syukur'].includes(state.type)) boxH = 400;
            else if (state.type === 'sekolahminggu') boxH = 280; 
            
            const boxX = 100, boxW = W-200;
            
            ctx.fillStyle = (state.contrast === 'light') ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.15)';
            ctx.strokeStyle = (state.contrast === 'light') ? 'rgba(0,0,0,0.4)' : 'rgba(255,255,255,0.6)';
            
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(boxX, yPos, boxW, boxH, 25);
            ctx.fill();
            ctx.stroke();

            yPos += 40;
            ctx.fillStyle = mainColor;
            
            if(['rt','syukur'].includes(state.type)) {
                ctx.font = '38px "Segoe UI"';
                yPos = wrapText(ctx, `Wilayah: ${state.data.wilayah}`, boxX+40, yPos, boxW-80, 48);
                yPos += 10;
                ctx.font = 'bold 45px "Segoe UI"';
                yPos = wrapText(ctx, state.data.keluarga, boxX+40, yPos, boxW-80, 55);
                yPos += 10;
                ctx.font = '38px "Segoe UI"';
                yPos = wrapText(ctx, `üìç ${state.data.alamat}`, boxX+40, yPos, boxW-80, 48);
                yPos += 50;
                ctx.font = '35px "Segoe UI"';
                ctx.fillText(`Pelayan Firman: ${state.data.pelayan}`, W/2, yPos);
                // Tampilkan asal gereja jika ada untuk RT (baru ditambah)
                if(state.data.asal) {
                    yPos += 35;
                    ctx.font = '30px "Segoe UI"';
                    ctx.fillStyle = subColor;
                    ctx.fillText(state.data.asal, W/2, yPos);
                }
            } else if (state.type === 'sekolahminggu') {
                ctx.font = '38px "Segoe UI"';
                ctx.fillText("Tema:", W/2, yPos);
                yPos += 60;
                ctx.font = 'bold 55px "Segoe UI"';
                yPos = wrapText(ctx, state.data.tema, boxX+40, yPos, boxW-80, 60);
            } else if (state.type === 'praremaja') {
                ctx.font = '38px "Segoe UI"';
                ctx.fillText("Tema:", W/2, yPos);
                yPos += 60;
                ctx.font = 'bold 55px "Segoe UI"';
                yPos = wrapText(ctx, state.data.tema, boxX+40, yPos, boxW-80, 60);
            } else {
                ctx.font = '38px "Segoe UI"';
                ctx.fillText("Pelayan Firman:", W/2, yPos);
                yPos += 60;
                ctx.font = 'bold 40px "Segoe UI"';
                yPos = wrapText(ctx, state.data.pelayan, boxX+40, yPos, boxW-80, 65);
                if(state.data.asal) {
                    yPos += 10; 
                    ctx.font = '38px "Segoe UI"';
                    ctx.fillStyle = subColor;
                    ctx.fillText(`(${state.data.asal})`, W/2, yPos);
                }
                
                if(state.type === 'umum' && state.data.ket) {
                    yPos += 50;
                    ctx.fillStyle = mainColor;
                    ctx.font = '35px "Segoe UI"';
                    ctx.beginPath();
                    ctx.arc(W/2 - (ctx.measureText(state.data.ket).width/2 + 20), yPos, 5, 0, Math.PI*2);
                    ctx.fill();
                    yPos = wrapText(ctx, `Catatan: ${state.data.ket}`, boxX+40, yPos, boxW-80, 45);
                }
            }

            ctx.fillStyle = subColor;
            ctx.font = '30px "Segoe UI"';
            ctx.fillText("www.gkigriyamerpatimas.or.id", W/2, H-100);
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let currentY = y;
            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    ctx.fillText(line, x + maxWidth/2, currentY);
                    line = words[n] + ' ';
                    currentY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x + maxWidth/2, currentY);
            return currentY + lineHeight;
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            if(!t) return;
            t.textContent = msg;
            t.style.background = type === 'success' ? '#28a745' : '#dc3545';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>